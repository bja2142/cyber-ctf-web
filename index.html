
<!DOCTYPE html>
<html>
<head>
<title>Student Panel</title>
<link rel="icon" type="image/png" href="/css/img/insignia-small.png">
<link rel="stylesheet" href="css/style.css">

<script type="text/javascript" src="js/jquery.js"> </script>
<script type="text/javascript" src="js/jsrender.js"> </script>

<script type="text/javascript">

function login_ctfd(data, url, username, password, count) {
	var nonce = data.split('<input id="nonce" name="nonce" type="hidden" value="')[1].split('">')[0];
	request_data = {
		"name": username,
		"password": password,
		"_submit": "Submit",
		"nonce": nonce
		
	}
	$.ajax({
		type: "POST",
		url: url,
		data: request_data,
		xhrFields: {
      		withCredentials: true
   		},
		success: function(data) {
			console.log(data)
		},
		error: function(data) {
			console.log("Failure");
			console.log(data);
		}

	})
}

function login_guacamole(data, url, username, password) {
	var nonce = data.split('<input id="nonce" name="nonce" type="hidden" value="')[1].split('">')[0];
	request_data = {
		"name": username,
		"password": password,
		"_submit": "Submit",
		"nonce": nonce
		
	}
	$.ajax({
		type: "POST",
		url: url,
		data: request_data,
		xhrFields: {
      		withCredentials: true
   		},
		success: function(data) {
			console.log(data)
		},
		error: function(data) {
			console.log("Failure");
			console.log(data);
		}

	})
}

function download_student_priv_key() {

	var key_contents = localStorage.getItem("studentKey");
	key_contents = JSON.parse(key_contents);
	const file = new File([key_contents["privateKey"]], "student_private_key.pem", {
		type: 'text/plain',
	})
  	const link = document.createElement('a')
  	const url = URL.createObjectURL(file)

  	link.href = url
  	link.download = file.name
  	document.body.appendChild(link)
  	link.click()

  	document.body.removeChild(link)
  	window.URL.revokeObjectURL(url)
}

function dict_to_formdata(data) {
	var form_data = new FormData();

	for ( var key in data ) {
		form_data.append(key, data[key]);
	}
	return form_data;
}

function auto_login_ctfd() {
	// First load page in iframe to get cookie set.
	// Then use that cookie to login.
	// otherwise, a new cookie is used and login doesn't work.
	var ctfd_url = "https://ctfd."+localStorage.getItem("StackFrontDomain")+"/"
	var ctfd_iframe = $("<iframe id='temporary_iframe'></iframe>");
	ctfd_iframe.on("load",function() {
		var login_url = ctfd_url+"login";
		$.ajax({type:"GET", url:login_url, xhrFields: {
			withCredentials: true
		},
		success: function(page_source) {
			var ctfd_url = login_url;
				login_ctfd(page_source, ctfd_url, "student", localStorage.getItem("StudentCTFdPassword"))
			}});
	});
	ctfd_iframe.attr("src", ctfd_url)
		.css("display", "none")
		.appendTo("body");
}

function auto_login_guacamole() {
	var guac_url = "https://guacamole."+localStorage.getItem("StackFrontDomain")+"/api/tokens"
	$.post(ctfd_url, function(page_source) {
				login_ctfd(page_source, ctfd_url, "student", localStorage.getItem("StudentCTFdPassword"))
			});
}

function refreshTimerValue() {
	$.get(localStorage.getItem("timerURL"), function(data){
		localStorage.setItem("timerExpire",data);
	});
}

function updateTimerDisplay() {
	var expireTime = localStorage.getItem("timerExpire");
	if (!expireTime) {
		return;
	}
	var timeNow = Math.round(new Date().getTime() /1000);
	var timeLeft = Math.max(expireTime - timeNow,0);
	var minutes = Math.floor(timeLeft / 60)
	var hours = Math.floor(minutes /60)
	minutes = minutes % 60
	var seconds = timeLeft % 60
	var timerString = String(hours).padStart(2,0) + ":"+ String(minutes).padStart(2,0) + ":" + String(seconds).padStart(2,0)
	$(".timer-value").text(timerString)
}

function afterLoadEvents() {
	if(localStorage.getItem("StudentCTFdPassword") != null) {
		auto_login_ctfd();
	}
	if(localStorage.getItem("timerURL") != null) {
		refreshTimerValue();
		setInterval(refreshTimerValue,1000*60);
		setInterval(updateTimerDisplay,1000);
	}
	if(localStorage.getItem("cancelTeardownKeyURL") != null) {
		$.get(localStorage.getItem("cancelTeardownKeyURL"), function() {
			show_teardown_canceled();
		});
	}
}


$(function() {
    if (window.location.search.indexOf("signed_uri") === -1) {
		if(localStorage.getItem("StudentStackIdentifier") == null) {
			$("#dynamic_box").empty();
        	$("#dynamic_box").prepend($.templates("#no_creds").render({})); 
		} else {
			$("#dynamic_box").empty();
            $("#dynamic_box").prepend($.templates("#user_info_template").render(localStorage));
		}
          
    } else {
        var signed_uri = window.location.search.split("signed_uri=")[1];
        var decoded_uri = atob(signed_uri)
        $.getJSON( decoded_uri, function(data) {
			Object.entries(data).forEach(([key,value]) => {
				if (typeof value === 'object') {
					value = JSON.stringify(value);
				}
				localStorage.setItem(key, value);
			});
            console.log(data);
			$("#dynamic_box").empty();
            $("#dynamic_box").prepend($.templates("#user_info_template").render(data));
			afterLoadEvents();
        });
    }

	afterLoadEvents();

})

function show_teardown_canceled()
{
	$("#cancel_teardown").empty();
	$("#teardown_narrative").empty();
	$("#cancel_teardown").text("Automated teardown has been canceled.")
}

function show_teardown_cancel_failed()
{
	$("#cancel_teardown").empty();
	$("#teardown_narrative").empty();
	$("#cancel_teardown").text("Automated teardown cancelation failed")
}

function cancel_teardown()
{
	if(localStorage.getItem("CancelTeardownAPI") != null) {
		$.get(localStorage.getItem("CancelTeardownAPI"), function(data) {
			if(data == "success") {
				show_teardown_canceled();
			} else {
				show_teardown_cancel_failed();
			}
		})
	} else {
		console.log("Cannot find key in storage: CancelTeardownAPI ")
	}
}


</script>
<script type="text/x-jsrender" id="user_info_template">
	<div class="user_info">
	<h3>Login Information</h3>
		<div class="login-section">
			<div class="section-label"><span>CTFd</span> [<a href="javascript:void(0);" onclick="javascript:$(this).parent().siblings('.credentials').toggle()">Toggle Credentials</a>]</div>
			<div class="credentials">
			<ul class="credentials-list">
				<li>
					<span class="label">Domain:</span>
					<code class="descriptor">ctfd.{{:StackFrontDomain}}</code>
				</li>
				<li>
					<span class="label">Username:</span>
					<code class="descriptor">student</code>
				</li>
				<li>
					<span class="label">Password:</span>
            		<code class="descriptor">{{:StudentCTFdPassword}}</code>
				</li>
			</ul>    
			</div>  
			<div class="launch-button">
				<a target="_new" href="https://ctfd.{{:StackFrontDomain}}/">
					<button>Open CTFd</button>
				</a>
			</div>      
		</div>
		<div class="login-section">
			<div class="section-label"><span>Student VM</span> [<a href="javascript:void(0);" onclick="javascript:$(this).parent().siblings('.credentials').toggle()">Toggle Credentials</a>]</div>
			<div class="credentials">
			<ul class="credentials-list">
				<li>
					<span class="label">Domain:</span>
					<code class="descriptor">{{:VMDomain}}</code>
				</li>
				<li>
					<span class="label">Username:</span>
					<code class="descriptor">{{:StudentVMUsername}}</code>
				</li>
				<li>
					<span class="label">Password:</span>
            		<code class="descriptor">{{:StudentVMPassword}}</code>
				</li>
				<li>
					<span class="label">Guacamole URL:</span>
					<code class="descriptor">{{:GuacURL}}</code>

				</li>
				<li>
					<span class="label">Guacamole Username:</span>
					<code class="descriptor">{{:StudentGuacUsername}}</code>
				</li>
				<li>
					<span class="label">Guacamole Password:</span>
					<code class="descriptor">{{:StudentGuacPassword}}</code>
				</li>
			</ul>    
			</div>
			
			<div class="launch-button">
				
				<button class="descriptor" onclick="javascript:download_student_priv_key()">Download SSH Key</button>
				<a target="_new" href="{{:GuacURL}}/#/client/U1NIAGMAZGVmYXVsdA/?username=student&password={{:StudentGuacPassword}}"><button>Web-SSH</button></a>
				<a target="_new" href="{{:GuacURL}}/#/client/Vk5DAGMAZGVmYXVsdA/?username=student&password={{:StudentGuacPassword}}"><button>Web-VNC</button></a>
			</div>      
		</div>
		<div class="login-section">
			<div class="section-label"><span>Session Timer</span></div>
			<div class="timer-value"><center>[Not Started]</center></div>
		</div>
		<div class="teardown-section">
			<div class="section-label"><span>Session Teardown</span></div>
			<div id="teardown_narrative">
				<p>Your Student VM will be torn down shortly after the timer expires.</p>
				<p>The rest of your assessment infrastructure will be torn down after a backup is completed of all logs.</p>
				<p>If there were any irregularities with your assessment that you feel may have impacted the results, please select the below button to defer destruction. Then reach out to your proctor to request a manual review.</p>
			</div>
			<div id="cancel_teardown">
				<a href="javascript:cancel_teardown()">
					<button>Cancel Automated Teardown</button>
				</a>
			</div>
		</div>
	</div>
</script>

<script type="text/x-jsrender" id="no_creds">
	<div class="error">
	<h3>No Creds Found</h3>
		<p>
			You are trying to access this resource without the signed URL.
            Please use the signed URL. If you do not have a signed URL,
            please contact your administrator for more help.
		</p>
	</div>
</script>


<script type="text/x-jsrender" id="error_template">
	<div class="error">
	<h3>There was an error. </h3>

			{{if errors}}
			<p><strong>Error information:</strong> "{{:errors}}"</p>
			{{/if}}

		<p>
			{{:error_text}}
		</p>

		<p>
		</p>
	</div>
</script>


</head>
<body>
	<div class="outer">
    <div class="content-background">
	<div class="content">
		<h1>Cyber Assessment</h2>
		<div id="dynamic_box"><center>Loading...</center></div>
		<noscript>Sorry, you need javascript.</noscript>
	</div>
    </div>
	</div>

</body>
</html>
